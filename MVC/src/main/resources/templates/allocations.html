<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="#{listOfRents}"></title>
    <link rel="stylesheet" type="text/css" href="/styles.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

<div th:replace="~{fragments/header.html :: header}"></div>

<main class="main">
    <div th:replace="~{fragments/sidebar.html :: sidebar}"></div>

    <div class="content">
        <h1 th:text="#{listOfRents}"></h1>

        <div>
            <label for="search">Filtruj po ID klienta:</label>
            <input type="text" id="search" value="${clientId}" placeholder="Wpisz ID klienta...">
            <button id="resetFilter" type="button">Pokaż wszystkie</button>
        </div>

        <div th:if="${message}">
            <p th:text="${message}"></p>
        </div>

        <table id="rentsTable">
            <thead>
            <tr>
                <th>ID</th>
                <th th:text="#{rentCost}"></th>
                <th>client ID</th>
                <th>item ID</th>
                <th th:text="#{endRent}"></th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="rent : ${rents}">
                <td th:text="${rent.id}"></td>
                <td th:text="${rent.rentCost}"></td>
                <td th:text="${rent.clientId}"></td>
                <td th:text="${rent.itemId}"></td>
                <td>
                    <form th:action="@{/return/{id}(id=${rent.id})}" method="POST">
                        <button class="return" type="submit" th:text="#{return}"></button>
                    </form>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</main>

<div th:replace="~{fragments/footer.html :: footer}"></div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const searchInput = document.getElementById('search');
        const resetFilterButton = document.getElementById('resetFilter');
        const rentsTableBody = document.querySelector("#rentsTable tbody");

        function loadRents(clientId = '') {
            const url = clientId ? `/rents/active/clientId/${clientId}` : '/rents/active';
            console.log("Request URL: ", url);

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Response data: ", data);
                    rentsTableBody.innerHTML = '';
                    if (data.length === 0) {
                        rentsTableBody.innerHTML = "<tr><td colspan='5'>Brak wyników</td></tr>";
                    } else {
                        data.forEach(rent => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${rent.id}</td>
                                <td>${rent.rentCost}</td>
                                <td>${rent.clientId}</td>
                                <td>${rent.itemId}</td>
                                <td>
                                    <form action="/return/${rent.id}" method="POST">
                                        <button class="return" type="submit">Return</button>
                                    </form>
                                </td>
                            `;
                            rentsTableBody.appendChild(row);
                        });
                    }
                })
                .catch(error => {
                    console.error("Błąd ładowania danych: ", error);
                });
        }

        searchInput.addEventListener('input', function() {
            const clientId = searchInput.value.trim();
            console.log("Client ID przy zmianie: ", clientId);
            if (clientId) {
                loadRents(clientId);
            } else {
                loadRents();
            }
        });

        resetFilterButton.addEventListener('click', () => {
            searchInput.value = '';
            loadRents();
        });

        loadRents();
    });
</script>

</body>
</html>
